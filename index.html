<!DOCTYPE html>
<html lang="en-TT"> <!-- Added language and region -->
<head>
    <meta charset="UTF-8">
    <!-- Updated Viewport Meta Tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Meta Tags -->
    <title>T&T PAYE & Annuity Calculator | Trinidad & Tobago Tax, Retirement Planner</title>
    <meta name="description" content="Free Trinidad & Tobago PAYE calculator and annuity/pension planner. Estimate your take-home pay, NIS, Health Surcharge, and explore tax-saving retirement strategies with expert Kyron Marchan. Plan your financial future in T&T.">
    <meta name="keywords" content="Trinidad and Tobago PAYE calculator, T&T tax calculator, annuity planner Trinidad, retirement planning T&T, NIS calculator, Health Surcharge T&T, take-home pay calculator Trinidad, financial planner T&T, BIR T&T, Kyron Marchan, tatil, tatil life, pension plan calculator">
    <meta name="author" content="Kyron Marchan">
    <link rel="canonical" href="https://kelsean868.github.io/paye-annuity-calculator-tt/"> 

    <!-- Open Graph Meta Tags (for Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="T&T PAYE & Annuity Calculator | Trinidad & Tobago Tax, Retirement Planner">
    <meta property="og:description" content="Free Trinidad & Tobago PAYE calculator and annuity/pension planner. Estimate your take-home pay, NIS, Health Surcharge, and explore tax-saving retirement strategies.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kelsean868.github.io/paye-annuity-calculator-tt/"> 
    <meta property="og:image" content="https://raw.githubusercontent.com/Kelsean868/paye-annuity-calculator-tt/refs/heads/main/tt-calculator-icon%202.png"> 
    <meta property="og:image:width" content="1200"> <!-- Standard OG image width -->
    <meta property="og:image:height" content="630"> <!-- Standard OG image height -->
    <meta property="og:site_name" content="T&T PAYE & Annuity Planner">
    <meta property="og:locale" content="en_TT">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="T&T PAYE & Annuity Calculator | Trinidad & Tobago Tax, Retirement Planner">
    <meta name="twitter:description" content="Free Trinidad & Tobago PAYE calculator and annuity/pension planner. Estimate your take-home pay, NIS, Health Surcharge, and explore tax-saving retirement strategies.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/Kelsean868/paye-annuity-calculator-tt/refs/heads/main/tt-calculator-icon%202.png"> 
    <!-- <meta name="twitter:site" content="@yourtwitterhandle"> --> <!-- Optional: Your Twitter handle -->
    <!-- <meta name="twitter:creator" content="@kyronmarchan"> --> <!-- Optional: Creator's Twitter handle -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "T&T PAYE & Annuity Calculator",
      "description": "A free financial calculator to estimate PAYE (Pay As You Earn) tax, National Insurance Scheme (NIS) contributions, Health Surcharge, and take-home pay for Trinidad and Tobago. Also provides insights into registered annuity and company pension plan savings for retirement planning.",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "browserRequirements": "Requires a modern web browser with JavaScript enabled.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "TTD"
      },
      "provider": {
        "@type": "Person",
        "name": "Kyron Marchan",
        "jobTitle": "Licensed Insurance Agent",
        "worksFor": {
            "@type": "Organization",
            "name": "Tatil Life & TATIL"
        }
      },
      "keywords": "Trinidad and Tobago PAYE calculator, T&T tax calculator, annuity planner Trinidad, retirement planning T&T, NIS calculator, Health Surcharge T&T, take-home pay calculator Trinidad, financial planner T&T, BIR T&T, Kyron Marchan",
      "url": "https://kelsean868.github.io/paye-annuity-calculator-tt/", 
      "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https://kelsean868.github.io/paye-annuity-calculator-tt/" 
       }
    }
    </script>

    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --bg-secondary: #f8f9fa; 
            --bg-accent: #eef2f7;    
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625; 
            --secondary-accent-darker: #8c6c1d;
            --success-color: #2a9d8f; 
            --paye-emphasis-color: #6b46c1; 
            --paye-emphasis-light-bg: #f4f0ff; 
            --paye-emphasis-medium-bg: #e9d8fd; 

            --shadow-soft: 0 3px 6px rgba(0,0,0,0.04);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.06);
            --shadow-strong: 0 8px 25px rgba(0,0,0,0.08);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif; 
            --base-font-size: 16px; 
            --line-height-relaxed: 1.65; 
        }

        .dark-mode {
            --bg-main: #1f2937; 
            --bg-bento-box: #2b3c4d; 
            --bg-secondary: #374151; 
            --bg-accent: #4B5563;    
            --text-primary: #f0f4f8; 
            --text-secondary: #d1d5db; 
            --text-muted: #9ca3af;    
            --border-color: #4b5f71; 
            --primary-accent: #25a1af; 
            --primary-accent-darker: #1e838f;
            --secondary-accent: #daa520; 
            --secondary-accent-darker: #b8860b;
            --success-color: #38c172; 
            --paye-emphasis-color: #b794f4; 
            --paye-emphasis-light-bg: #44337a; 
            --paye-emphasis-medium-bg: #553c9a; 
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            font-weight: 400;
            font-size: var(--base-font-size);
            line-height: var(--line-height-relaxed);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }
        
        .page-title { font-family: var(--font-heading); color: var(--primary-accent); font-weight: 700; }
        .page-subtitle { font-family: var(--font-body); font-weight: 600; color: var(--text-secondary); }
        
        .bento-section-title { 
            font-family: var(--font-heading); 
            font-weight: 700; 
            color: var(--text-primary);
            margin-bottom: 1.25rem; 
        }
        .bento-step-indicator {
            display: inline-flex; align-items: center; justify-content: center;
            background-color: var(--secondary-accent); color: var(--bg-bento-box);
            border-radius: 50%; width: 34px; height: 34px;
            font-family: var(--font-body); font-weight: 700; font-size: 1rem;
            margin-right: 12px; box-shadow: var(--shadow-soft);
        }
        .dark-mode .bento-step-indicator { color: var(--text-primary); }

        .bento-grid-container {
            display: grid;
            gap: 1.75rem; 
        }

        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
            border: 1px solid var(--border-color);
        }
        .bento-box:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-strong);
        }

        @media (min-width: 1024px) { 
            .bento-grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
            .bento-box-financial-details { grid-column: span 1; grid-row: 1 / 2; } 
            .bento-box-paye-results { grid-column: span 2; grid-row: 1 / 2; } 
            #payAllocationChartSection { grid-column: 1 / -1; } 
            .bento-box-annuity-insights { grid-column: 1 / -1; } 
            .bento-box-cta { grid-column: 1 / -1; }
        }
         @media (min-width: 768px) and (max-width: 1023px) { 
            .bento-grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
            .bento-box-financial-details, .bento-box-paye-results { grid-column: span 1; }
             #payAllocationChartSection { grid-column: span 2; }
            .bento-box-annuity-insights, .bento-box-cta { grid-column: span 2; }
        }
        /* Mobile: all bento boxes take full width and stack */
        @media (max-width: 767px) {
            .bento-box {
                 grid-column: span 1 / span 1 !important; 
            }
            #annuityInsightsSection > div.rounded-lg { 
                 padding-left: 0.5rem; 
                 padding-right: 0.5rem;
            }
        }


        /* Tooltip */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 260px; background-color: var(--text-primary); color: var(--bg-bento-box); text-align: center; 
            border-radius: 0.375rem; padding: 10px; position: absolute; z-index: 20; bottom: 135%;
            left: 50%; margin-left: -130px; opacity: 0; transition: opacity 0.3s ease; box-shadow: var(--shadow-medium);
            font-size: 0.8rem; font-weight: 500;
        }
        .tooltip .tooltiptext::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: var(--text-primary) transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext, .info-icon:focus + .tooltiptext { /* Show on focus for accessibility */
            visibility: visible; 
            opacity: 1; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 9px; }
        ::-webkit-scrollbar-track { background: var(--bg-accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-accent); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary-accent-darker); }

        /* Info Icon */
        .info-icon {
            display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px;
            background-color: var(--primary-accent); color: var(--bg-bento-box); border-radius: 50%;
            font-size: 11px; font-weight: 600; cursor: pointer; margin-left: 6px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .info-icon:hover, .info-icon:focus { /* Add focus style */
            background-color: var(--primary-accent-darker); 
            transform: scale(1.15); 
            outline: 2px solid var(--secondary-accent); /* Example focus outline */
            outline-offset: 2px;
        }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(29, 45, 53, 0.7); padding-top: 5vh; 
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-bento-box); margin: auto; padding: 2rem 2.25rem; border: 1px solid var(--border-color);
            width: 90%; max-width: 560px; border-radius: 0.75rem; text-align: left; position: relative;
            box-shadow: var(--shadow-strong); transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .modal-close {
            color: var(--text-muted); position: absolute; top: 0.75rem; right: 1rem; font-size: 2.25rem; font-weight: 300;
        }
        .modal-close:hover, .modal-close:focus { color: var(--text-primary); text-decoration: none; cursor: pointer; }

        /* Recommendation Card */
        .recommendation-card {
            border: 1px solid var(--border-color); 
            border-left: 5px solid var(--secondary-accent);
            border-radius: 0.625rem; padding: 1.5rem; background-color: var(--bg-secondary);
            margin-bottom: 1.5rem; box-shadow: var(--shadow-soft);
            transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }
        .recommendation-card:hover { transform: scale(1.02); }


        /* Chart Styling Modifications */
        .chart-container { 
            position: relative;
            height: 320px; 
            width: 100%; 
            margin: 1.5rem auto 0; 
            background-color: var(--bg-secondary);
            border-radius: 0.625rem;
            padding: 0.75rem; 
            transition: background-color 0.3s ease, border-color 0.3s ease;
            touch-action: pan-y; 
            overflow: hidden; 
        }
        .pie-chart-container { 
            height: 380px; /* Increased height for larger pie charts */
        } 
        .charts-view-wrapper { margin-top: 1.75rem; }

        @media (max-width: 767px) {
            .bento-box { 
                padding-left: 0.75rem; 
                padding-right: 0.75rem;
            }
            #annuityInsightsSection > div.rounded-lg { 
                 padding-left: 0.5rem; 
                 padding-right: 0.5rem;
            }
            .recommendation-card { 
                padding-left: 0.5rem; 
                padding-right: 0.5rem;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            .chart-container {
                height: 260px; 
                padding: 0.25rem; 
            }
            .pie-chart-container {
                height: 300px; 
            }
            .chart-container canvas {
                max-width: 100%; 
                height: auto !important; 
            }
             .chartjs-size-monitor {
                overflow: visible !important; 
            }
            .chart-legend { 
                flex-wrap: wrap;
                gap: 10px; 
             }
            .charts-view-wrapper #taxSavingsView > .grid {
                 grid-template-columns: 1fr;
            }
        }


        /* Dynamic Quote Display */
        #dynamicQuoteDisplay {
            min-height: 4.25em; transition: opacity 0.5s ease-in-out, background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            opacity: 1; padding: 1.5rem; background-color: var(--bg-accent); border-left: 5px solid var(--secondary-accent);
            border-radius: 0.625rem; box-shadow: var(--shadow-soft); color: var(--text-secondary);
            font-family: var(--font-heading); font-style: italic; text-align: center; margin-bottom: 1.75rem; font-size: 1rem; font-weight: 600;
        }
        #dynamicQuoteDisplay.fade-out { opacity: 0; }

        /* Final CTA Section (as a bento box) */
        .cta-bento-box {
            background: linear-gradient(135deg, var(--primary-accent) 0%, var(--primary-accent-darker) 100%);
            color: white; 
        }
        .dark-mode .cta-bento-box {
             background: linear-gradient(135deg, var(--primary-accent-darker) 0%, var(--primary-accent) 100%);
        }
        .dark-mode .cta-bento-box p, .dark-mode .cta-bento-box h2, .dark-mode .cta-bento-box a { color: #fff; }
         .cta-bento-box a:hover { color: var(--secondary-accent); } 


        /* Input and Button Styling */
        input[type="number"], select,
        #customQuoteModal input[type="text"], #customQuoteModal input[type="tel"] {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;  /* Prevents iOS auto-zoom */
            background-color: var(--bg-secondary); color: var(--text-primary);
            font-weight: 500;
        }
        input[type="number"]:focus, select:focus,
        #customQuoteModal input[type="text"]:focus, #customQuoteModal input[type="tel"]:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
        .button-base {
            font-weight: 600; padding-top: 0.85rem; padding-bottom: 0.85rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-soft); text-transform: uppercase; letter-spacing: 0.025em;
            font-family: var(--font-body);
            touch-action: manipulation; 
        }
        .button-base:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        
        .main-calc-button { 
            background-color: var(--primary-accent); color: white; font-size: 1rem; 
        }
        .dark-mode .main-calc-button { color: var(--bg-bento-box); }
        .main-calc-button:hover { background-color: var(--primary-accent-darker); }
        
        .secondary-action-button { 
            background-color: var(--secondary-accent); color: white; 
        }
        .dark-mode .secondary-action-button { color: var(--text-primary); }
        .secondary-action-button:hover { background-color: var(--secondary-accent-darker); }
        
        .tertiary-action-button { 
            background-color: var(--bg-accent); color: var(--text-secondary); border: 1px solid var(--border-color); 
        }
        .tertiary-action-button:hover { background-color: color-mix(in srgb, var(--bg-accent) 80%, #000); }
        
        .final-cta-button { 
             background-color: var(--secondary-accent); color: white; 
             font-weight: 700; font-size: 1rem; padding: 0.9rem 1.5rem;
        }
        .dark-mode .final-cta-button { color: var(--text-primary); }
        .final-cta-button:hover { background-color: var(--secondary-accent-darker); }

        /* Result Item & Take Home Pay Card */
        .result-item {
            background-color: var(--bg-accent); padding: 0.85rem; border-radius: 0.375rem; border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
        }
         .result-item strong { 
            display: block; 
            width: 100%;
        }
        /* PAYE Snapshot result items - using new variables */
        .result-item-paye-emphasis {
            background-color: var(--paye-emphasis-light-bg);
            color: var(--paye-emphasis-color);
        }
        .result-item-paye-emphasis-bold {
            background-color: var(--paye-emphasis-medium-bg);
            color: var(--paye-emphasis-color);
            font-weight: 700;
        }
        .dark-mode .result-item-paye-emphasis-bold { 
             color: var(--text-primary); 
        }


        .take-home-pay-card {
            background-color: var(--success-color-light); padding: 1.5rem; border-radius: 0.625rem; border: 1px solid var(--success-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .dark-mode .take-home-pay-card { background-color: color-mix(in srgb, var(--success-color) 20%, transparent); }
        .take-home-pay-card .amount { color: var(--success-color); font-weight: 700; }
        .dark-mode .take-home-pay-card .amount { color: #5ae093; }
        .take-home-pay-card .label { color: color-mix(in srgb, var(--success-color) 75%, #000); font-weight: 600; }
        .dark-mode .take-home-pay-card .label { color: #a7f3d0; }

        #customQuoteModal label { font-weight: 600; color: var(--text-secondary); }
        
        /* Theme Toggle Switch */
        .theme-switch-wrapper { 
            display: flex; 
            align-items: center; 
            background-color: var(--bg-bento-box); 
            padding: 0.5rem 0.75rem; 
            border-radius: 999px; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid var(--border-color);
        }
      
        .theme-switch { position: relative; display: inline-block; width: 40px; height: 20px;  touch-action: manipulation; } 
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 20px;
        }
        .dark-mode .slider { background-color: var(--primary-accent); }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; 
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider:before { transform: translateX(20px); } 
        #themeToggleLabel { color: var(--text-secondary); font-size: 0.7rem; font-weight: 600; letter-spacing: 0.025em;}

        /* Mobile Floating Buttons */
        .mobile-floating-button {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .mobile-floating-button.hidden-by-scroll { /* For JS to toggle opacity/visibility */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8 selection:bg-amber-500 selection:text-white">

    <div class="w-full max-w-6xl mx-auto my-8"> 
        <header class="mb-10 md:mb-14 text-center relative"> 
            <h1 class="page-title text-4xl sm:text-5xl md:text-6xl mb-3">
                Smart Money Hub for T&T
            </h1>
            <h2 class="page-subtitle text-xl sm:text-2xl md:text-3xl">
                See Your Take-Home Pay & Grow Your Annuity Savings - Simply!
            </h2>
            <p class="text-[var(--text-secondary)] mt-5 text-md md:text-lg max-w-3xl mx-auto">
                Easily figure out your T&T money. See your take-home pay, find smart ways to save with annuities, and plan for a comfy retirement.
            </p>
        </header>
        <!-- Moved Theme Toggle Wrapper to be after header, before bento grid, and centered -->
        <div class="w-full flex justify-center my-4 md:my-6">
            <div class="theme-switch-wrapper">
                <span class="mr-2 text-xs" id="themeToggleLabel">LIGHT</span>
                <label class="theme-switch" for="themeToggleCheckbox">
                    <input type="checkbox" id="themeToggleCheckbox" />
                    <div class="slider round"></div>
                </label>
            </div>
        </div>


        <div class="bento-grid-container initial-view" id="bentoGrid">
            <section class="bento-box bento-box-financial-details space-y-6">
                <h2 class="bento-section-title text-center text-xl md:text-2xl"><span class="bento-step-indicator">1</span>Tell Us About Your Finances</h2> <!-- Centered Title -->
                <div>
                    <label for="age" class="block text-sm font-medium text-[var(--text-secondary)] mb-1.5">Your Age Now</label>
                    <input type="number" id="age" name="age" placeholder="e.g., 35" class="mt-1 block w-full">
                </div>
                <div>
                    <label for="incomeFrequency" class="block text-sm font-medium text-[var(--text-secondary)] mb-1.5">How Often You're Paid</label>
                    <select id="incomeFrequency" name="incomeFrequency" class="mt-1 block w-full">
                        <option value="annual">Annually</option>
                        <option value="monthly" selected>Monthly</option> 
                        <option value="fortnightly">Fortnightly</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <div>
                    <label for="grossIncome" id="grossIncomeLabel" class="block text-sm font-medium text-[var(--text-secondary)] mb-1.5">
                        Your Gross Pay (before anything's taken out, per pay period)
                        <div class="tooltip inline-block">
                            <span class="info-icon" tabindex="0" aria-label="More information about Gross Pay">?</span> <!-- Added tabindex and aria-label -->
                            <span class="tooltiptext" id="grossIncomeTooltipText">Your total earnings before any deductions, for the frequency selected above.</span>
                        </div>
                    </label>
                    <input type="number" id="grossIncome" name="grossIncome" placeholder="TTD" class="mt-1 block w-full" aria-describedby="grossIncomeTooltipText">
                </div>

                <!-- New Annuity/Pension Branching Logic -->
                <div>
                    <label for="hasAnnuityProduct" class="block text-sm font-medium text-[var(--text-secondary)] mb-1.5">
                        Do you save in a Registered Annuity or Company Pension?
                        <div class="tooltip inline-block">
                             <span class="info-icon" tabindex="0" aria-label="More information about Registered Annuity or Company Pension">?</span>
                            <span class="tooltiptext" id="hasAnnuityTooltipText">If your annuity or pension helps lower your taxes, it's probably 'Registered'.</span>
                        </div>
                    </label>
                    <select id="hasAnnuityProduct" name="hasAnnuityProduct" class="mt-1 block w-full" aria-describedby="hasAnnuityTooltipText">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>

                <div id="companyPensionContainer" class="hidden mt-4"> 
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1.5">
                        Your Company Pension Savings (what YOU pay from your salary)
                         <div class="tooltip inline-block">
                            <span class="info-icon" tabindex="0" aria-label="More information about Company Pension Savings">?</span>
                            <span class="tooltiptext" id="companyPensionTooltipText">Enter ONLY your contribution from your salary, not your employer's match or the total. This helps lower your taxes.</span>
                        </div>
                    </label>
                    <div class="mt-1 flex space-x-4 mb-2">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio" name="companyPensionInputType" value="amount" checked>
                            <span class="ml-2 text-xs text-[var(--text-secondary)]">Enter Dollar Amount</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio" name="companyPensionInputType" value="percentage">
                            <span class="ml-2 text-xs text-[var(--text-secondary)]">Enter as a Percentage (%)</span>
                        </label>
                    </div>

                    <div id="companyPensionAmountContainer">
                         <label for="companyPension" id="companyPensionAmountLabel" class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Contribution Amount (per pay period)</label>
                        <input type="number" id="companyPension" name="companyPension" placeholder="TTD (per pay period)" class="mt-1 block w-full" aria-describedby="companyPensionTooltipText">
                    </div>
                    <div id="companyPensionPercentageContainer" class="hidden">
                        <label for="companyPensionPercentage" class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Contribution Percentage</label>
                        <input type="number" id="companyPensionPercentage" name="companyPensionPercentage" placeholder="% of Gross Pay (e.g., 5)" class="mt-1 block w-full text-sm" aria-describedby="companyPensionTooltipText">
                    </div>
                </div>

                <div id="personalAnnuityContainer" class="hidden mt-4"> 
                    <label for="personalAnnuity" id="personalAnnuityLabel" class="block text-sm font-medium text-[var(--text-secondary)] mb-1.5">
                        Your Personal Registered Annuity Savings (per pay period)
                         <div class="tooltip inline-block">
                            <span class="info-icon" tabindex="0" aria-label="More information about Personal Annuity Savings">?</span>
                            <span class="tooltiptext" id="personalAnnuityTooltipText">How much you save in your own BIR-approved annuity, for that pay period.</span>
                        </div>
                    </label>
                    <input type="number" id="personalAnnuity" name="personalAnnuity" placeholder="TTD (per pay period)" class="mt-1 block w-full" aria-describedby="personalAnnuityTooltipText">
                </div>
                <!-- End of New Annuity/Pension Branching Logic -->
                
                <button id="calculateButton" class="w-full main-calc-button button-base text-white py-3 px-4 mt-4">
                    Show Me My Plan!
                </button>
            </section>

            <section id="resultsSection" class="bento-box bento-box-paye-results space-y-6 hidden">
                <h2 class="bento-section-title text-center text-xl md:text-2xl"><span class="bento-step-indicator">2</span>Your Pay Breakdown (<span id="resultsFrequencyDisplay"></span>)</h2> <!-- Centered Title -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 text-xs sm:text-sm"> 
                    <div class="result-item flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelGrossIncome">Your Gross Pay</span>:</strong></div> <span id="resGrossIncomeSelectedFreq"></span></div>
                    <div class="result-item flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelPersonalAllowance">Your Tax-Free Allowance</span>:</strong></div> <span id="resPersonalAllowanceSelectedFreq"></span></div>
                    <div class="result-item flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelTotalNIS">Your Total NIS Payment</span>:</strong></div> <span id="resTotalNISSelectedFreq"></span></div>
                    <div class="result-item flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelDeductibleNIS">NIS Part That Lowers Tax</span>:</strong></div> <span id="resDeductibleNISSelectedFreq"></span></div>
                    <div class="result-item flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelDeductibleRegAnnuity">Annuity/Pension That Lowers Tax</span>:</strong></div> <span id="resDeductibleRegAnnuitySelectedFreq"></span></div>
                    <div class="result-item flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelTotalDeductions">Total Tax-Lowering Deductions</span>:</strong></div> <span id="resTotalDeductionsSelectedFreq"></span></div>
                    <div class="result-item result-item-paye-emphasis font-semibold flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelTaxableIncome">Income You Pay Tax On</span>:</strong></div> <span id="resTaxableIncomeSelectedFreq"></span></div>
                    <div class="result-item result-item-paye-emphasis flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelHealthSurcharge">Health Surcharge Payment</span>:</strong></div> <span id="resHealthSurchargeSelectedFreq"></span></div>
                    <div class="result-item result-item-paye-emphasis-bold flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelIncomeTax">Income Tax Payable</span>:</strong></div> <span id="resIncomeTaxSelectedFreq"></span></div>
                    <div class="result-item result-item-paye-emphasis-bold flex flex-col items-center"><div class="mb-0.5"><strong><span id="labelTotalPAYE">Total PAYE (Tax + NIS + Health)</span>:</strong></div> <span id="resTotalPAYESelectedFreq"></span></div>
                </div>
                 <div class="mt-6 p-5 take-home-pay-card text-center">
                    <p class="text-lg font-semibold label" id="labelAnnualTakeHomePay">Your Estimated Annual Take-Home Pay</p>
                    <p class="text-3xl md:text-4xl font-bold amount mt-1" id="resAnnualTakeHomePay"></p>
                    <p class="text-md font-medium label mt-3" id="labelTakeHomePaySelectedFreq">Your Take-Home Pay (per pay period)</p> <!-- Added mt-3 for spacing -->
                    <p class="text-xl md:text-2xl font-bold amount" id="resTakeHomePaySelectedFreq"></p>
                </div>
            </section>

            <!-- New Pay Allocation Chart Section -->
            <section id="payAllocationChartSection" class="bento-box bento-box-annuity-insights hidden"> 
                 <h2 class="bento-section-title text-center text-xl md:text-2xl mb-6"><span class="bento-step-indicator">3</span>Your Detailed Pay Allocation (<span id="payAllocationFrequencyDisplay"></span>)</h2>
                 <div class="chart-container pie-chart-container mx-auto"> 
                     <canvas id="payAllocationPieChart"></canvas>
                 </div>
                 <p class="text-center text-sm text-[var(--text-muted)] mt-2">Hover or tap on slices to see details.</p>
            </section>
        
            <section id="annuityInsightsSection" class="bento-box bento-box-annuity-insights hidden">
                 <h2 class="bento-section-title text-center text-xl md:text-2xl mb-6"><span class="bento-step-indicator">4</span>Smart Annuity Plans & How They Grow</h2> <!-- Updated Step Indicator -->
                <div class="py-5 px-0 sm:px-5 md:p-6 rounded-lg md:bg-[var(--bg-secondary)]"> 
                    <div id="existingAnnuityInsight" class="mb-7 pb-7 border-b border-[var(--border-color)]"></div>
                    
                    <h3 id="exploreFurtherHeading" class="text-lg md:text-xl font-semibold text-[var(--success-color)] mt-5 mb-3">Your Custom Annuity Growth Plans:</h3>
                    <p id="exploreFurtherIntro" class="text-[var(--text-secondary)] text-sm mb-6">See how saving a bit more can boost your retirement fund. Click a plan to see the numbers.</p>
                    
                    <div id="annuityRecommendationsContainer" class="space-y-6">
                        </div>

                    <div id="customAnnuityInputSection" class="mt-10 pt-8 border-t border-[var(--border-color)]">
                        <h3 class="text-lg md:text-xl font-semibold text-[var(--success-color)] mb-4">Want to Try Your Own Annuity Idea?</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-5 gap-y-4 items-end">
                            <div class="sm:col-span-2 md:col-span-1">
                                <label for="customAnnuityAmount" class="block text-xs font-medium text-[var(--text-secondary)] mb-1">How much to save</label>
                                <input type="number" id="customAnnuityAmount" placeholder="TTD" class="mt-1 block w-full text-sm">
                            </div>
                            <div>
                                <label for="customAnnuityFrequency" class="block text-xs font-medium text-[var(--text-secondary)] mb-1">How often</label>
                                <select id="customAnnuityFrequency" class="mt-1 block w-full text-sm">
                                    <option value="monthly" selected>Monthly</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <button id="getCustomQuoteBtn" class="w-full secondary-action-button button-base text-sm py-2.5 px-3">
                                Get My Free Quote (via WhatsApp)
                            </button>
                        </div>
                        <p id="customQuoteStatusMessage" class="text-xs mt-3 text-center min-h-[1em]" aria-live="polite" aria-atomic="true"></p> 
                    </div>
                    
                    <div id="generalAnnuityPromptWrapper" class="mt-8 pt-8 border-t border-[var(--border-color)]">
                         <p id="dynamicQuoteDisplay"></p>
                         <div id="generalAnnuityPromptContent" class="text-[var(--text-secondary)] leading-relaxed text-sm"></div>
                    </div>
                     <p class="mt-8 text-xs text-[var(--text-muted)] text-center">
                        Disclaimer: Estimates are for illustrative purposes. Not financial advice. Tax laws and rates subject to change. Consult a qualified financial advisor & BIR. Annuity terms & conditions apply.
                    </p>
                </div>
            </section>

            <!-- CTA Section Updated with Kyron Marchan's Information -->
            <section id="main-cta" class="bento-box bento-box-cta cta-bento-box">
                <div class="container mx-auto px-4 py-6 text-center">
                    <h2 class="text-xl md:text-2xl font-bold mb-4">Ready for a Secure Retirement?</h2>
                    <p class="text-sm md:text-base mb-3 max-w-lg mx-auto">
                        A planned future is a peaceful one! Get a FREE chat with Kyron Marchan, our T&T annuity expert, to create a plan just for you.
                    </p>
                    <p class="text-xs italic mb-5 max-w-xl mx-auto">
                        Kyron Marchan: Licensed Insurance Agent (Tatil Life & TATIL) with 13 years in retirement planning.
                    </p>
                    <div class="space-y-3 md:space-y-0 md:flex md:justify-center md:space-x-4">
                        <a href="mailto:kyron.marchan@tatil.co.tt?subject=Annuity Inquiry from PAYE Calculator App" class="final-cta-button button-base py-2.5 px-6 text-base inline-block w-full md:w-auto"> <!-- Updated Subject Line -->
                            Email Kyron for Free Advice
                        </a>
                        <a href="https://wa.me/18683278273?text=Hello%20Kyron,%20I'd%20like%20to%20discuss%20my%20financial%20plan." target="_blank" class="final-cta-button button-base bg-green-500 hover:bg-green-600 py-2.5 px-6 text-base inline-block w-full md:w-auto" style="background-color: #25D366; border-color: #25D366;">
                            Chat on WhatsApp
                        </a>
                    </div>
                    <div class="mt-6 text-xs">
                        <p>Or Call Kyron Now:</p>
                        <p class="text-lg font-bold mt-0.5"><a href="tel:+18683278273" class="hover:text-[var(--secondary-accent)] transition-colors">+1 (868) 327-8273</a></p>
                        <p class="mt-1">(Kyron Marchan | Local T&T Expert | BIR Approved Plans)</p>
                    </div>
                </div>
            </section>
        </div> 
        
        <footer class="text-center mt-12 text-xs text-[var(--text-muted)]">
            <p>&copy; <span id="currentYear"></span> Sleek Bento Annuity Planner TT. Plan with Precision, Retire with Confidence.</p>
            <!-- Back to Top Button -->
            <button id="backToTopButton" class="mobile-floating-button fixed bottom-4 right-4 bg-[var(--primary-accent)] hover:bg-[var(--primary-accent-darker)] text-white p-3 rounded-full shadow-lg z-50 flex items-center justify-center opacity-0 invisible" title="Back to Top">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19V5"></path>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
            </button>
        </footer>
    </div>

    <!-- Removed Mobile & Desktop Reset Buttons -->

    <div id="alertModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('alertModal')">&times;</span>
        <p id="alertModalMessage" class="text-[var(--text-primary)] text-lg"></p>
        <button onclick="closeModal('alertModal')" class="mt-6 button-base bg-[var(--primary-accent)] hover:bg-[var(--primary-accent-darker)] text-white font-semibold py-2.5 px-6">OK</button>
      </div>
    </div>

    <div id="customQuoteModal" class="modal"> 
      <div class="modal-content">
        <span class="modal-close" id="closeCustomQuoteModalBtn">&times;</span>
        <h3 class="text-xl md:text-2xl font-semibold mb-4 text-[var(--primary-accent)]">Get Your Free Annuity Quote</h3>
        <p class="text-[var(--text-secondary)] text-sm mb-6">Just give us your name and WhatsApp number, and an expert will send your quote...</p>
        <form id="customQuoteForm" class="space-y-5">
            <div>
                <label for="userName" class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Full Name</label>
                <input type="text" id="userName" name="userName" required class="mt-1 block w-full">
            </div>
            <div>
                <label for="whatsappNumber" class="block text-xs font-medium text-[var(--text-secondary)] mb-1">WhatsApp Number</label>
                <input type="tel" id="whatsappNumber" name="whatsappNumber" required placeholder="e.g., +18681234567" class="mt-1 block w-full">
            </div>
            <div id="customQuoteFormError" class="text-[var(--paye-emphasis-color)] text-xs text-left hidden min-h-[1em]" aria-live="polite" aria-atomic="true"></div>
            <button type="submit" class="w-full secondary-action-button button-base text-sm py-3 px-4">
                Send My Quote Request
            </button>
        </form>
      </div>
    </div>

    <script>
        // --- GLOBAL FLAGS & CONSTANTS ---
        window.initialCalculationPerformed = false; 
        let chartInstances = {}; 
        const TAX_CONSTANTS = {
            PERSONAL_ALLOWANCE: 90000,
            MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED: 60000,
            BRACKET_1_LIMIT: 1000000,
            RATE_1: 0.25,
            RATE_2: 0.30
        };
        const TIME_CONSTANTS = {
            WEEKS_IN_YEAR: 52,
            FORTNIGHTS_IN_YEAR: 26,
            MONTHS_IN_YEAR: 12,
            FOUR_WEEKS: 4 // Approx. weeks in a month
        };
        const NIS_CONSTANTS = {
            TABLE: [ { minMonthly: 0, maxMonthly: 866.99, weeklyEmpContrib: 0 }, { minMonthly: 867.00, maxMonthly: 1472.99, weeklyEmpContrib: 11.90 }, { minMonthly: 1473.00, maxMonthly: 1949.99, weeklyEmpContrib: 17.40 }, { minMonthly: 1950.00, maxMonthly: 2642.99, weeklyEmpContrib: 23.30 }, { minMonthly: 2643.00, maxMonthly: 3292.99, weeklyEmpContrib: 30.10 }, { minMonthly: 3293.00, maxMonthly: 4029.99, weeklyEmpContrib: 37.20 }, { minMonthly: 4030.00, maxMonthly: 4852.99, weeklyEmpContrib: 45.10 }, { minMonthly: 4853.00, maxMonthly: 5632.99, weeklyEmpContrib: 53.20 }, { minMonthly: 5633.00, maxMonthly: 6456.99, weeklyEmpContrib: 61.40 }, { minMonthly: 6457.00, maxMonthly: 7409.99, weeklyEmpContrib: 70.40 }, { minMonthly: 7410.00, maxMonthly: 8276.99, weeklyEmpContrib: 79.60 }, { minMonthly: 8277.00, maxMonthly: 9272.99, weeklyEmpContrib: 89.10 }, { minMonthly: 9273.00, maxMonthly: 10312.99, weeklyEmpContrib: 99.40 }, { minMonthly: 10313.00, maxMonthly: 11396.99, weeklyEmpContrib: 110.20 }, { minMonthly: 11397.00, maxMonthly: 12652.99, weeklyEmpContrib: 122.10 }, { minMonthly: 12653.00, maxMonthly: 13599.99, weeklyEmpContrib: 133.30 }, { minMonthly: 13600.00, maxMonthly: Infinity, weeklyEmpContrib: 138.10 } ],
            EMPLOYEE_CONTRIB_PERCENTAGE: 0.70
        };
        const HEALTH_SURCHARGE_CONSTANTS = {
            MONTHLY_THRESHOLD: 469.99,
            RATE_HIGH_WEEKLY: 8.25,
            RATE_LOW_WEEKLY: 4.80
        };
        const CURRENCY_SYMBOL = "TTD "; 
        const RETIREMENT_AGE = 65;
        const ASSUMED_ANNUITY_INTEREST_RATE = 0.025; 
        let quoteIntervalId = null;
        const QUOTE_INTERVAL_MS = 20000; 
        const QUOTE_FADE_DURATION_MS = 500; 
        const retirementQuotes = [ 
            "Your future self will thank you for planning today!",
            "Retirement: More time for doubles and beach limes!",
            "Annuities: Like a savings plan with superpowers for your retirement.",
            "Don't just dream about retirement, build it!",
            "Small savings today, big adventures tomorrow!",
            "Let's make your retirement as sweet as a sugar cake!",
            "Future you called, they said 'Thanks for the annuity!'",
            "Secure your tomorrows, so you can enjoy your todays.",
            "Annuities: Your personal 'do not disturb' sign for financial worries in retirement.",
            "Plant your money tree today with an annuity, enjoy the shade later."
        ]; 

        // --- DOM ELEMENTS ---
        const themeToggle = document.getElementById('themeToggleCheckbox');
        const body = document.body; 
        const themeToggleLabel = document.getElementById('themeToggleLabel');
        const bentoGrid = document.getElementById('bentoGrid');
        const resultsSection = document.getElementById('resultsSection');
        const payAllocationChartSection = document.getElementById('payAllocationChartSection'); 
        const annuityInsightsSection = document.getElementById('annuityInsightsSection');
        const financialDetailsBox = document.querySelector('.bento-box-financial-details');
        const payeResultsBox = document.querySelector('.bento-box-paye-results');
        const annuityInsightsBox = document.querySelector('.bento-box-annuity-insights');
        const ctaBox = document.querySelector('.bento-box-cta');
        const calculateButton = document.getElementById('calculateButton');
        const ageInput = document.getElementById('age');
        const incomeFrequencySelect = document.getElementById('incomeFrequency');
        const grossIncomeInput = document.getElementById('grossIncome');
        
        const hasAnnuityProductSelect = document.getElementById('hasAnnuityProduct');
        const companyPensionContainer = document.getElementById('companyPensionContainer');
        const personalAnnuityContainer = document.getElementById('personalAnnuityContainer');
        const companyPensionInput = document.getElementById('companyPension'); 
        const companyPensionPercentageInput = document.getElementById('companyPensionPercentage'); 
        const personalAnnuityInput = document.getElementById('personalAnnuity'); 
        const companyPensionInputTypeRadios = document.querySelectorAll('input[name="companyPensionInputType"]');
        const companyPensionAmountContainer = document.getElementById('companyPensionAmountContainer');
        const companyPensionPercentageContainer = document.getElementById('companyPensionPercentageContainer');

        const customQuoteModalEl = document.getElementById('customQuoteModal');
        const closeCustomQuoteModalBtn = document.getElementById('closeCustomQuoteModalBtn');
        const getCustomQuoteBtn = document.getElementById('getCustomQuoteBtn'); 
        const customQuoteForm = document.getElementById('customQuoteForm');
        const customAnnuityAmountInput = document.getElementById('customAnnuityAmount'); 
        const customAnnuityFrequencySelect = document.getElementById('customAnnuityFrequency'); 
        const customQuoteStatusMessageEl = document.getElementById('customQuoteStatusMessage'); 
        const customQuoteFormErrorEl = document.getElementById('customQuoteFormError');
        const userNameInput = document.getElementById('userName');
        const whatsappNumberInput = document.getElementById('whatsappNumber');
        const backToTopButton = document.getElementById('backToTopButton');


        // --- UTILITY FUNCTIONS (Defined early) ---
        function displayRandomQuote() {
            const quoteDisplayEl = document.getElementById('dynamicQuoteDisplay');
            if (quoteDisplayEl) {
                quoteDisplayEl.classList.add('fade-out'); 
                setTimeout(() => {
                    const randomIndex = Math.floor(Math.random() * retirementQuotes.length); 
                    quoteDisplayEl.textContent = `"${retirementQuotes[randomIndex]}"`;
                    quoteDisplayEl.classList.remove('fade-out'); 
                }, QUOTE_FADE_DURATION_MS);
            }
        }
        function formatCurrency(value, decimalPlaces = 2) {
            if (isNaN(value)) return CURRENCY_SYMBOL + "0" + (decimalPlaces > 0 ? "." + "0".repeat(decimalPlaces) : "");
            return CURRENCY_SYMBOL + Number(value).toLocaleString(undefined, { minimumFractionDigits: decimalPlaces, maximumFractionDigits: decimalPlaces });
        }
        
        function getEmployeeNISWeeklyContribution(currentGrossAnnualIncome) {
            const grossMonthlyIncome = currentGrossAnnualIncome / TIME_CONSTANTS.MONTHS_IN_YEAR;
            for (const tier of NIS_CONSTANTS.TABLE) { if (grossMonthlyIncome >= tier.minMonthly && grossMonthlyIncome <= tier.maxMonthly) return tier.weeklyEmpContrib; } return 0;
        }
         
        function getHealthSurchargeWeeklyRate(currentGrossAnnualIncome) {
            const monthlyIncome = currentGrossAnnualIncome / TIME_CONSTANTS.MONTHS_IN_YEAR;
            if (monthlyIncome <= 0) return 0;
            return monthlyIncome > HEALTH_SURCHARGE_CONSTANTS.MONTHLY_THRESHOLD ? HEALTH_SURCHARGE_CONSTANTS.RATE_HIGH_WEEKLY : HEALTH_SURCHARGE_CONSTANTS.RATE_LOW_WEEKLY;
        }
        function showAlert(message) {
            const alertModal = document.getElementById('alertModal'); const alertModalMessage = document.getElementById('alertModalMessage');
            if(alertModal && alertModalMessage) { alertModalMessage.textContent = message; alertModal.style.display = "flex"; }
        }
        function closeModal(modalId) { const modalToClose = document.getElementById(modalId); if (modalToClose) modalToClose.style.display = "none"; }
        function getFrequencyDivisor(frequency) {
            switch (frequency) { 
                case 'annual': return 1; 
                case 'monthly': return TIME_CONSTANTS.MONTHS_IN_YEAR; 
                case 'fortnightly': return TIME_CONSTANTS.FORTNIGHTS_IN_YEAR; 
                case 'weekly': return TIME_CONSTANTS.WEEKS_IN_YEAR; 
                default: return 1; 
            }
        }
        function capitalizeFirstLetter(string) { if (!string) return ''; return string.charAt(0).toUpperCase() + string.slice(1); }
        function calculateIncomeTax(currentTaxableIncome) {
            let tax = 0;
            if (currentTaxableIncome <= TAX_CONSTANTS.BRACKET_1_LIMIT) tax = currentTaxableIncome * TAX_CONSTANTS.RATE_1;
            else tax = (TAX_CONSTANTS.BRACKET_1_LIMIT * TAX_CONSTANTS.RATE_1) + ((currentTaxableIncome - TAX_CONSTANTS.BRACKET_1_LIMIT) * TAX_CONSTANTS.RATE_2);
            return Math.max(0, tax);
        }
        function calculateFutureValueAnnuity(principalAnnual, rate, years) {
            if (years <= 0) return principalAnnual > 0 ? principalAnnual : 0; if (rate === 0) return principalAnnual * years;
            let futureValue = 0; for (let i = 0; i < years; i++) { futureValue = (futureValue + principalAnnual) * (1 + rate); } return futureValue;
        }
        function generateGrowthData(principalAnnual, rate, years) {
            const data = []; const labels = []; let currentValue = 0;
            for (let i = 0; i <= years; i++) {
                labels.push(i === 0 ? "Today" : `Year ${i}`); 
                if (i === 0) data.push(0); else { currentValue = (currentValue + principalAnnual) * (1 + rate); data.push(currentValue); }
            } return { labels, data };
        }
        function getChartColors() {
            const root = document.documentElement; 
            const isDark = root.classList.contains('dark-mode'); 
            const style = getComputedStyle(root); 
            
            const darkChartTickLabelColor = '#e5e7eb'; 
            const darkChartTitleColor = '#f3f4f6';   
            return {
                pie: { 
                    incomeTax: style.getPropertyValue('--paye-emphasis-color').trim(), 
                    payeEmphasis: style.getPropertyValue('--paye-emphasis-color').trim(), 
                    healthSurcharge: style.getPropertyValue('--primary-accent').trim(), 
                    nis: style.getPropertyValue('--secondary-accent').trim(), 
                    takeHome: style.getPropertyValue('--success-color').trim(), 
                    borderColor: style.getPropertyValue('--border-color').trim() 
                },
                line: { 
                    borderColor: style.getPropertyValue('--primary-accent').trim(), 
                    backgroundColor: style.getPropertyValue('--primary-accent').trim() + '33', 
                    borderColorAlt: style.getPropertyValue('--secondary-accent').trim(), 
                    backgroundColorAlt: style.getPropertyValue('--secondary-accent').trim() + '33', 
                    pointBackgroundColor: style.getPropertyValue('--primary-accent').trim(),
                    pointBorderColor: style.getPropertyValue('--bg-bento-box').trim(), 
                    gridColor: style.getPropertyValue('--border-color').trim() + '66', 
                    ticksColor: isDark ? darkChartTickLabelColor : style.getPropertyValue('--text-muted').trim() 
                },
                fontFamily: style.getPropertyValue('--font-body').trim(),
                textPrimaryColor: isDark ? darkChartTitleColor : style.getPropertyValue('--text-primary').trim(), 
                textSecondaryColor: isDark ? darkChartTickLabelColor : style.getPropertyValue('--text-secondary').trim() 
            };
        }
        
        Chart.register(ChartDataLabels); 

        function renderPieChart(canvasId, chartTitle, labels, dataValues, showLegend = true) { 
            if (chartInstances[canvasId] && typeof chartInstances[canvasId].destroy === 'function') chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId); if (!ctx) return;
            const colors = getChartColors();
            const isMobile = window.innerWidth < 768;
            
            const chartOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    title: { display: true, text: chartTitle, padding: { top: 12, bottom: 12}, font: { size: isMobile ? 13 : 16, family: colors.fontFamily, weight: '700' }, color: colors.textPrimaryColor }, 
                    tooltip: { bodyFont: { family: colors.fontFamily, size: 11 }, titleFont: { family: colors.fontFamily, size: 12, weight: '600' }, callbacks: { label: (context) => `${context.label || ''}: ${formatCurrency(context.parsed, 0)}` } }, 
                    legend: { display: showLegend, position: isMobile ? 'top' : 'bottom', labels: { font: { size: isMobile ? 10 : 12, family: colors.fontFamily }, color: colors.textSecondaryColor, boxWidth: isMobile ? 10 : 18, padding: isMobile ? 8 : 15 } },
                    datalabels: {
                        display: function(context) {
                            return labels.length === 2 && (labels[context.dataIndex] === 'Total PAYE' || labels[context.dataIndex] === 'Take-home Pay'); 
                        },
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => {
                                sum += data;
                            });
                            if (sum === 0) return '0%';
                            let percentage = (value*100 / sum).toFixed(0)+"%";
                            return percentage;
                        },
                        color: '#fff', 
                        font: {
                            weight: 'bold',
                            size: (isMobile && labels.length === 2) ? 9 : (labels.length === 2 ? 11 : (isMobile ? 10 : 12) )
                        },
                        anchor: 'center',
                        align: 'center'
                    }
                }, 
                layout: { padding: isMobile ? {left: 2, right: 2, top: 5, bottom: 5} : {left:10, right:10, top:10, bottom:10} }, 
                animation: { animateScale: true, animateRotate: true, duration: 700 } 
            };

            let backgroundColorsForChart = [];
            if (labels.length === 2 && labels[0] === 'Total PAYE' && labels[1] === 'Take-home Pay') { 
                 backgroundColorsForChart = [colors.pie.payeEmphasis, colors.pie.takeHome];
            } else if (labels.length === 4) { 
                backgroundColorsForChart = [colors.pie.healthSurcharge, colors.pie.nis, colors.pie.incomeTax, colors.pie.takeHome];
            }


            chartInstances[canvasId] = new Chart(ctx.getContext('2d'), {
                type: 'pie', data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Allocation', 
                        data: dataValues, 
                        backgroundColor: backgroundColorsForChart, 
                        borderColor: Array(dataValues.length).fill(colors.pie.borderColor), 
                        borderWidth: 1.5 
                    }] 
                },
                options: chartOptions
            });
        }
        function renderLineChart(canvasId, chartTitleOverall, datasetConfigsArray) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const isMobile = window.innerWidth < 768;
            const colors = getChartColors();
            
            const chartOptions = {
                responsive: true, 
                maintainAspectRatio: false, 
                layout: {
                     padding: isMobile ? { left: 2, right: 2, top: 5, bottom: 5 } : { top: 10, right: 20, bottom: 10, left: 20 } 
                },
                plugins: {
                    title: { display: true, text: chartTitleOverall, padding: {top: 12, bottom: 18}, font: { size: isMobile? 13 : 16, family: colors.fontFamily, weight: '700' }, color: colors.textPrimaryColor }, 
                    tooltip: { bodyFont: { family: colors.fontFamily, size: 11 }, titleFont: { family: colors.fontFamily, size: 12, weight: '600' }, callbacks: { label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw, 0)}` } },
                    legend: { 
                        position: isMobile ? 'top' : 'bottom', 
                        labels: { 
                            font: {size: isMobile ? 10 : 12, family: colors.fontFamily, weight: '600'}, 
                            color: colors.textSecondaryColor, 
                            boxWidth: isMobile ? 10 : 18, 
                            padding: isMobile ? 8 : 15 
                        } 
                    },
                    datalabels: { 
                        display: false
                    } 
                },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        grace: isMobile ? '2%' : '5%', 
                        ticks: { callback: (value) => formatCurrency(value, 0), font: {size: isMobile ? 9 : 11, family: colors.fontFamily}, color: colors.line.ticksColor }, 
                        grid: { color: colors.line.gridColor } 
                    },
                    x: { 
                        ticks: { 
                            autoSkip: true, 
                            maxRotation: isMobile ? 70 : 0, 
                            minRotation: isMobile ? 45 : 0, 
                            font: {size: isMobile ? 9 : 11, family: colors.fontFamily}, 
                            color: colors.line.ticksColor 
                        }, 
                        grid: { display: false } 
                    }
                },
                animation: { duration: 900, easing: 'easeOutCubic' } 
            };

            const chartDatasets = datasetConfigsArray.map(config => ({ 
                label: config.label, data: config.data, borderColor: config.borderColor, 
                backgroundColor: config.backgroundColor, fill: true, tension: config.tension || 0.35, 
                pointBackgroundColor: config.pointBackgroundColor || config.borderColor, 
                pointBorderColor: config.pointBorderColor || colors.line.pointBorderColor, 
                pointHoverBackgroundColor: config.pointHoverBackgroundColor || colors.line.pointBorderColor, 
                pointHoverBorderColor: config.pointHoverBorderColor || config.borderColor, 
                borderWidth: config.borderWidth || 2.5, 
                pointRadius: config.pointRadius || 4, 
                pointHoverRadius: config.pointHoverRadius || 6 
            }));

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels: datasetConfigsArray[0].labels, datasets: chartDatasets },
                options: chartOptions
            });
        }

        // --- BENTO GRID RESIZE LOGIC ---
        function adjustBentoLayout() {
            if (!bentoGrid || !resultsSection || !annuityInsightsSection || !financialDetailsBox || !payeResultsBox || !payAllocationChartSection ||!annuityInsightsBox || !ctaBox) {
                return;
            }
            const isResultsVisible = !resultsSection.classList.contains('hidden');
            const isPayAllocationChartVisible = !payAllocationChartSection.classList.contains('hidden');
            const isAnnuityVisible = !annuityInsightsSection.classList.contains('hidden');
            
            payeResultsBox.style.display = isResultsVisible ? 'block' : 'none';
            payAllocationChartSection.style.display = isPayAllocationChartVisible ? 'block' : 'none';
            annuityInsightsSection.style.display = isAnnuityVisible ? 'block' : 'none';


            [financialDetailsBox, payeResultsBox, payAllocationChartSection, annuityInsightsSection, ctaBox].forEach(el => { 
                el.style.gridColumn = ''; el.style.gridRow = '';
            });
            
            if (window.innerWidth >= 1024) {
                bentoGrid.classList.remove('initial-view');
                financialDetailsBox.style.gridColumn = '1 / 2';
                
                let rightColRowCount = 0;
                if(isResultsVisible) rightColRowCount++;
                if(isPayAllocationChartVisible) rightColRowCount++;
                
                financialDetailsBox.style.gridRow = `1 / span ${Math.max(1, rightColRowCount)}`;


                let currentRowForRightCol = 1;
                if (isResultsVisible) {
                    payeResultsBox.style.gridColumn = '2 / 4';
                    payeResultsBox.style.gridRow = `${currentRowForRightCol} / span 1`;
                    currentRowForRightCol++;
                }
                 if (isPayAllocationChartVisible) {
                    payAllocationChartSection.style.gridColumn = '2 / 4'; 
                    payAllocationChartSection.style.gridRow = `${currentRowForRightCol} / span 1`;
                    currentRowForRightCol++;
                 }
                
                let nextFullWidthRowStart = Math.max(1, rightColRowCount) + 1;
                 if (!isResultsVisible && !isPayAllocationChartVisible) { 
                    financialDetailsBox.style.gridColumn = '1 / -1'; 
                    nextFullWidthRowStart = 2; 
                 }


                 if (isAnnuityVisible) {
                    annuityInsightsSection.style.gridColumn = '1 / -1'; 
                    annuityInsightsSection.style.gridRow = `${nextFullWidthRowStart} / span 1`;
                    nextFullWidthRowStart++;
                }

                ctaBox.style.gridColumn = '1 / -1'; 
                ctaBox.style.gridRow = `${nextFullWidthRowStart} / span 1`;


            } else if (window.innerWidth >= 768) { // Tablet Layout
                 bentoGrid.classList.remove('initial-view');
                 financialDetailsBox.style.gridColumn = 'span 2'; 
                 if(isResultsVisible) payeResultsBox.style.gridColumn = 'span 2';
                 if(isPayAllocationChartVisible) payAllocationChartSection.style.gridColumn = 'span 2';
                 if(isAnnuityVisible) annuityInsightsSection.style.gridColumn = 'span 2';
                 ctaBox.style.gridColumn = 'span 2';
            } else { // Mobile Layout
                bentoGrid.classList.remove('initial-view');
                financialDetailsBox.style.gridColumn = 'span 1'; 
                if(isResultsVisible) payeResultsBox.style.gridColumn = 'span 1';
                if(isPayAllocationChartVisible) payAllocationChartSection.style.gridColumn = 'span 1';
                if(isAnnuityVisible) annuityInsightsSection.style.gridColumn = 'span 1';
                ctaBox.style.gridColumn = 'span 1';
            }
        }
        
        // --- New Function to Attach Event Listeners for Recommendation Cards ---
        function attachCardEventListeners(
            cardIndex, ids, percentValue, annualContrib, 
            currentIncomeTax, yearsToRet, 
            deductibleNIS, deductibleRegAnnuity, 
            taxableIncome, healthSurcharge, totalNIS, 
            takeHome, grossIncome, currentTotalPAYEAnnual 
        ) {
            const visualizeBtn = document.getElementById(ids.visualizeBtn);
            const chartsWrapper = document.getElementById(ids.chartsWrapper);
            const taxView = document.getElementById(ids.taxView);
            const growthView = document.getElementById(ids.growthView);
            const summary = document.getElementById(ids.summary);
            const toggleBtn = document.getElementById(ids.toggleBtn);

            if (!visualizeBtn || !chartsWrapper) {
                console.error(`Card ${cardIndex} elements not found for visualizeBtn or chartsWrapper. IDs:`, ids);
                return;
            }

            visualizeBtn.addEventListener('click', function(event) { 
                if (window.innerWidth < 768) { 
                    event.preventDefault();
                    resetMobileZoom();
                }
                const isCurrentlyVisible = chartsWrapper.style.display !== 'none';
                chartsWrapper.style.display = isCurrentlyVisible ? 'none' : 'block'; // Toggle visibility
                visualizeBtn.textContent = isCurrentlyVisible ? 'Explore Plan' : 'Hide Details';

                if (!isCurrentlyVisible) { // This means charts are NOW being made visible
                    if (currentIncomeTax > 0.01) { 
                        const remainingCapRoom = Math.max(0, TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED - (deductibleNIS + deductibleRegAnnuity));
                        const deductiblePortion = Math.min(annualContrib, remainingCapRoom);
                        const taxWithAnnuity = calculateIncomeTax(Math.max(0, taxableIncome - deductiblePortion));
                        
                        renderPieChart(ids.pieCurrent, 'Your Pay: Before New Savings', 
                            ['Total PAYE', 'Take-home Pay'], 
                            [currentTotalPAYEAnnual, takeHome],
                            true 
                        );
                        
                        const potentialPAYEWithThisAnnuityScenario = taxWithAnnuity + healthSurcharge + totalNIS;
                        const potentialTakeHomeWithThisAnnuityScenario = grossIncome - potentialPAYEWithThisAnnuityScenario;
                        renderPieChart(ids.piePotential, 'Your Pay: With New Savings', 
                            ['Total PAYE', 'Take-home Pay'], 
                            [potentialPAYEWithThisAnnuityScenario, potentialTakeHomeWithThisAnnuityScenario],
                            false 
                        );
                        
                        if (summary) { 
                            summary.innerHTML = `Potential Annual Tax Saving: <strong class="text-lg text-[var(--secondary-accent)]">${formatCurrency(currentIncomeTax - taxWithAnnuity, 0)}</strong>`;
                        }
                        if (taxView) taxView.style.display = 'block';
                        if (growthView) growthView.style.display = 'none';
                        if (toggleBtn) toggleBtn.textContent = 'See Growth Chart';

                    } else if (yearsToRet > 0) { 
                        const growthData = generateGrowthData(annualContrib, ASSUMED_ANNUITY_INTEREST_RATE, yearsToRet);
                        const chartColors = getChartColors();
                        renderLineChart(ids.growth, 'How Your Savings Could Grow', [{ 
                            label: 'Growth', 
                            data: growthData.data, 
                            labels: growthData.labels, 
                            borderColor: chartColors.line.borderColor, 
                            backgroundColor: chartColors.line.backgroundColor, 
                            pointBackgroundColor: chartColors.line.pointBackgroundColor, 
                            pointBorderColor: chartColors.line.pointBorderColor 
                        }]);
                    }
                    // After charts are potentially rendered and the wrapper is displayed, scroll it into view
                     if (chartsWrapper.style.display === 'block') {
                        setTimeout(() => { 
                            chartsWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 50); 
                    }
                }
            });

            if (currentIncomeTax > 0.01 && toggleBtn && taxView && growthView) {
                toggleBtn.addEventListener('click', function(event) { 
                     if (window.innerWidth < 768) { 
                        event.preventDefault();
                        resetMobileZoom();
                    }
                    const isTaxViewVisible = taxView.style.display !== 'none';
                    const chartColors = getChartColors();
                    if (isTaxViewVisible) { 
                        taxView.style.display = 'none';
                        growthView.style.display = 'block';
                        toggleBtn.textContent = 'See Tax Impact';
                        if (yearsToRet > 0) {
                            const remainingCapRoom = Math.max(0, TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED - (deductibleNIS + deductibleRegAnnuity));
                            const deductiblePortion = Math.min(annualContrib, remainingCapRoom);
                            const taxSaving = currentIncomeTax - calculateIncomeTax(Math.max(0, taxableIncome - deductiblePortion));
                            
                            let datasets = [{ 
                                label: 'Base Growth', 
                                data: generateGrowthData(annualContrib, ASSUMED_ANNUITY_INTEREST_RATE, yearsToRet).data, 
                                labels: generateGrowthData(annualContrib, ASSUMED_ANNUITY_INTEREST_RATE, yearsToRet).labels, 
                                borderColor: chartColors.line.borderColor, 
                                backgroundColor: chartColors.line.backgroundColor, 
                                pointBackgroundColor: chartColors.line.pointBackgroundColor, 
                                pointBorderColor: chartColors.line.pointBorderColor 
                            }];
                            if (taxSaving > 0) {
                                datasets.push({ 
                                    label: 'Growth + Reinvested Tax Savings', 
                                    data: generateGrowthData(annualContrib + taxSaving, ASSUMED_ANNUITY_INTEREST_RATE, yearsToRet).data, 
                                    labels: generateGrowthData(annualContrib + taxSaving, ASSUMED_ANNUITY_INTEREST_RATE, yearsToRet).labels, 
                                    borderColor: chartColors.line.borderColorAlt, 
                                    backgroundColor: chartColors.line.backgroundColorAlt, 
                                    pointBackgroundColor: chartColors.line.borderColorAlt, 
                                    pointBorderColor: chartColors.line.pointBorderColor 
                                });
                            }
                            renderLineChart(ids.growth, 'Savings Growth: Base vs. Reinvested Tax Savings', datasets);
                        }
                    } else { 
                        growthView.style.display = 'none';
                        taxView.style.display = 'block';
                        toggleBtn.textContent = 'See Growth Chart';
                        const remainingCapRoom = Math.max(0, TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED - (deductibleNIS + deductibleRegAnnuity));
                        const deductiblePortion = Math.min(annualContrib, remainingCapRoom);
                        const taxWithAnnuity = calculateIncomeTax(Math.max(0, taxableIncome - deductiblePortion));
                        
                        const potentialPAYEWithThisAnnuityScenario = taxWithAnnuity + healthSurcharge + totalNIS;
                        const potentialTakeHomeWithThisAnnuityScenario = grossIncome - potentialPAYEWithThisAnnuityScenario;

                        renderPieChart(ids.pieCurrent, 'Your Pay: Before New Savings', 
                            ['Total PAYE', 'Take-home Pay'], 
                            [currentTotalPAYEAnnual, takeHome],
                            true
                        );
                        renderPieChart(ids.piePotential, 'Your Pay: With New Savings', 
                            ['Total PAYE', 'Take-home Pay'], 
                            [potentialPAYEWithThisAnnuityScenario, potentialTakeHomeWithThisAnnuityScenario],
                            false
                        );
                    }
                     if (chartsWrapper.style.display === 'block') { 
                        setTimeout(() => {
                            chartsWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 50);
                    }
                });
            }
        }

        // --- Function to update frequency-specific text ---
        function updateFrequencySpecificText(frequencyString) {
            const freqText = capitalizeFirstLetter(frequencyString);
            const perFreqText = `(per ${freqText.toLowerCase()})`;
            const perFreqPlaceholder = `TTD (per ${freqText.toLowerCase()})`;

            const grossIncomeLabelEl = document.getElementById('grossIncomeLabel');
            if (grossIncomeLabelEl && grossIncomeLabelEl.childNodes[0]) { 
                grossIncomeLabelEl.childNodes[0].nodeValue = `Your Gross ${freqText} Pay (before anything's taken out) `;
            }

            const companyPensionAmountLabelEl = document.getElementById('companyPensionAmountLabel');
            if (companyPensionAmountLabelEl) {
                companyPensionAmountLabelEl.textContent = `Contribution Amount ${perFreqText}`;
            }
            if (companyPensionInput) { 
                companyPensionInput.placeholder = perFreqPlaceholder;
            }
            
            const personalAnnuityLabelEl = document.getElementById('personalAnnuityLabel');
            if (personalAnnuityLabelEl && personalAnnuityLabelEl.childNodes[0]) { 
                 personalAnnuityLabelEl.childNodes[0].nodeValue = `Your Personal Registered Annuity Savings ${perFreqText} `;
            }
            if (personalAnnuityInput) { 
                personalAnnuityInput.placeholder = perFreqPlaceholder;
            }

            const resultsFrequencyDisplayEl = document.getElementById('resultsFrequencyDisplay');
            if (resultsFrequencyDisplayEl) resultsFrequencyDisplayEl.textContent = freqText;
            
            const payAllocationFrequencyDisplayEl = document.getElementById('payAllocationFrequencyDisplay'); // New
            if(payAllocationFrequencyDisplayEl) payAllocationFrequencyDisplayEl.textContent = freqText;


            const labelGrossIncomeEl = document.getElementById('labelGrossIncome');
            if (labelGrossIncomeEl) labelGrossIncomeEl.textContent = `Your Gross ${freqText} Pay`;
            
            const labelPersonalAllowanceEl = document.getElementById('labelPersonalAllowance');
            if (labelPersonalAllowanceEl) labelPersonalAllowanceEl.textContent = `Your Tax-Free Allowance (${freqText})`;
            
            const labelTotalNISEl = document.getElementById('labelTotalNIS');
            if(labelTotalNISEl) labelTotalNISEl.textContent = `Your Total NIS Payment (${freqText})`;

            const labelDeductibleNISEl = document.getElementById('labelDeductibleNIS');
            if(labelDeductibleNISEl) labelDeductibleNISEl.textContent = `NIS Part That Lowers Tax (${freqText})`;
            
            const labelDeductibleRegAnnuityEl = document.getElementById('labelDeductibleRegAnnuity');
            if(labelDeductibleRegAnnuityEl) labelDeductibleRegAnnuityEl.textContent = `Annuity/Pension That Lowers Tax (${freqText})`;
            
            const labelTotalDeductionsEl = document.getElementById('labelTotalDeductions');
            if(labelTotalDeductionsEl) labelTotalDeductionsEl.textContent = `Total Tax-Lowering Deductions (${freqText})`;
            
            const labelTaxableIncomeEl = document.getElementById('labelTaxableIncome');
            if(labelTaxableIncomeEl) labelTaxableIncomeEl.textContent = `Income You Pay Tax On (${freqText})`;
            
            const labelIncomeTaxEl = document.getElementById('labelIncomeTax');
            if(labelIncomeTaxEl) labelIncomeTaxEl.textContent = `Income Tax Payable (${freqText})`;
            
            const labelTotalPAYEEl = document.getElementById('labelTotalPAYE');
            if(labelTotalPAYEEl) labelTotalPAYEEl.textContent = `Total PAYE (Tax + NIS + Health) (${freqText})`;
            
            const labelTakeHomePaySelectedFreqEl = document.getElementById('labelTakeHomePaySelectedFreq');
            if(labelTakeHomePaySelectedFreqEl) labelTakeHomePaySelectedFreqEl.textContent = `Your ${freqText} Take-Home Pay`;
        }
        
        // --- Main Calculation Function ---
        function performFullCalculation() {
            const age = parseInt(ageInput.value) || 0;
            const incomeFrequency = incomeFrequencySelect.value; 
            const grossIncomeInputVal = parseFloat(grossIncomeInput.value) || 0;

            const frequencyString = capitalizeFirstLetter(incomeFrequency); 
            const frequencyDivisor = getFrequencyDivisor(incomeFrequency);
            
            updateFrequencySpecificText(frequencyString); 
            
            // Mandatory income check happens here now
            if (grossIncomeInputVal <= 0 ) { 
                showAlert("Please enter your Gross Income to calculate your plan."); 
                if(calculateButton) calculateButton.textContent = "Show Me My Plan!"; // Reset button text if calc fails
                window.initialCalculationPerformed = false; // Ensure this is false if calc fails early
                return;
            }


            if (calculateButton && window.initialCalculationPerformed) { 
                calculateButton.textContent = "UPDATE MY PLAN";
            } else if (calculateButton) {
                 if (calculateButton.textContent !== "UPDATE MY PLAN") { 
                    calculateButton.textContent = "Show Me My Plan!";
                }
            }

            let companyPensionContribPerFreq = 0;
            let personalAnnuityContribPerFreq = 0;
            let totalAnnualRegisteredContrib = 0;

            const hasAnnuity = hasAnnuityProductSelect.value === 'yes';
            if (hasAnnuity) {
                const selectedPensionInputTypeRadio = document.querySelector('input[name="companyPensionInputType"]:checked');
                if (selectedPensionInputTypeRadio) {
                    const selectedPensionInputType = selectedPensionInputTypeRadio.value;
                    if (selectedPensionInputType === 'percentage') {
                        const companyPensionPercentageVal = parseFloat(companyPensionPercentageInput.value);
                        if (!isNaN(companyPensionPercentageVal) && companyPensionPercentageVal > 0) {
                            companyPensionContribPerFreq = (companyPensionPercentageVal / 100) * grossIncomeInputVal;
                        }
                    } else { // 'amount'
                        companyPensionContribPerFreq = parseFloat(companyPensionInput.value) || 0;
                    }
                } else { 
                     companyPensionContribPerFreq = parseFloat(companyPensionInput.value) || 0;
                }
                
                personalAnnuityContribPerFreq = parseFloat(personalAnnuityInput.value) || 0;

                let multiplier = 1;
                if (incomeFrequency === 'monthly') multiplier = TIME_CONSTANTS.MONTHS_IN_YEAR;
                else if (incomeFrequency === 'fortnightly') multiplier = TIME_CONSTANTS.FORTNIGHTS_IN_YEAR;
                else if (incomeFrequency === 'weekly') multiplier = TIME_CONSTANTS.WEEKS_IN_YEAR;

                totalAnnualRegisteredContrib = (companyPensionContribPerFreq * multiplier) + (personalAnnuityContribPerFreq * multiplier);
            }


            if (age <= 0 || age >= RETIREMENT_AGE) { 
                if (window.initialCalculationPerformed || document.activeElement === calculateButton) {
                     showAlert(`Please enter a valid current age below ${RETIREMENT_AGE} (e.g., 18-${RETIREMENT_AGE -1}). Projections are to age ${RETIREMENT_AGE}.`);
                }
                if (age < RETIREMENT_AGE && age <=0) return; 
            }
            
             if (companyPensionContribPerFreq < 0 && (window.initialCalculationPerformed || document.activeElement === calculateButton)) { 
                showAlert("Company Pension contribution cannot be negative.");
                if(companyPensionInput) companyPensionInput.value = 0; 
                if(companyPensionPercentageInput) companyPensionPercentageInput.value = '';
                return;
            }
            if (personalAnnuityContribPerFreq < 0 && (window.initialCalculationPerformed || document.activeElement === calculateButton)) { 
                showAlert("Personal Annuity contribution cannot be negative.");
                if(personalAnnuityInput) personalAnnuityInput.value = 0; return;
            }

            let grossAnnualIncome = 0;
            switch (incomeFrequency) {
                case 'annual': grossAnnualIncome = grossIncomeInputVal; break;
                case 'monthly': grossAnnualIncome = grossIncomeInputVal * TIME_CONSTANTS.MONTHS_IN_YEAR; break;
                case 'fortnightly': grossAnnualIncome = grossIncomeInputVal * TIME_CONSTANTS.FORTNIGHTS_IN_YEAR; break;
                case 'weekly': grossAnnualIncome = grossIncomeInputVal * TIME_CONSTANTS.WEEKS_IN_YEAR; break;
                default: if (window.initialCalculationPerformed || document.activeElement === calculateButton) showAlert("Invalid income frequency selected."); return;
            }
            
            if (grossAnnualIncome <=0 && (window.initialCalculationPerformed || document.activeElement === calculateButton)) { 
                 showAlert("Calculated Annual Income is not valid. Please check your input."); return;
            }

            const employeeNISWeekly = getEmployeeNISWeeklyContribution(grossAnnualIncome);
            const totalEmployeeNISAnnual = employeeNISWeekly * TIME_CONSTANTS.WEEKS_IN_YEAR;
            const healthSurchargeWeekly = getHealthSurchargeWeeklyRate(grossAnnualIncome);
            const healthSurchargeAnnual = healthSurchargeWeekly * TIME_CONSTANTS.WEEKS_IN_YEAR;
            const deductibleNISPortion = totalEmployeeNISAnnual * NIS_CONSTANTS.EMPLOYEE_CONTRIB_PERCENTAGE; 
            let actualDeductibleRegisteredAnnuityInput = 0; let actualDeductibleNIS = 0;

            if (deductibleNISPortion >= TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED) {
                actualDeductibleNIS = TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED; actualDeductibleRegisteredAnnuityInput = 0; 
            } else {
                actualDeductibleNIS = deductibleNISPortion;
                actualDeductibleRegisteredAnnuityInput = Math.min(totalAnnualRegisteredContrib, TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED - actualDeductibleNIS);
            }
            
            const totalAllowableDeductionsAnnual = TAX_CONSTANTS.PERSONAL_ALLOWANCE + actualDeductibleNIS + actualDeductibleRegisteredAnnuityInput;
            let taxableIncomeAnnual = Math.max(0, grossAnnualIncome - totalAllowableDeductionsAnnual); 
            let incomeTaxAnnual = calculateIncomeTax(taxableIncomeAnnual);
            const totalPAYEAnnual = incomeTaxAnnual + healthSurchargeAnnual + totalEmployeeNISAnnual; 
            const annualTakeHomePay = grossAnnualIncome - totalPAYEAnnual; 
            
            document.getElementById('resGrossIncomeSelectedFreq').textContent = formatCurrency(grossIncomeInputVal); 
            document.getElementById('resPersonalAllowanceSelectedFreq').textContent = formatCurrency(TAX_CONSTANTS.PERSONAL_ALLOWANCE / frequencyDivisor);
            
            let nisForDisplayFreq, hsForDisplayFreq, incomeTaxForFrequency, takeHomeForFrequency;
            if (incomeFrequency === 'monthly') { 
                nisForDisplayFreq = employeeNISWeekly * TIME_CONSTANTS.FOUR_WEEKS; 
                hsForDisplayFreq = healthSurchargeWeekly * TIME_CONSTANTS.FOUR_WEEKS; 
            } else if (incomeFrequency === 'fortnightly') { 
                nisForDisplayFreq = employeeNISWeekly * 2; 
                hsForDisplayFreq = healthSurchargeWeekly * 2; 
            } else if (incomeFrequency === 'weekly') { 
                nisForDisplayFreq = employeeNISWeekly; 
                hsForDisplayFreq = healthSurchargeWeekly; 
            } else { // Annual
                nisForDisplayFreq = totalEmployeeNISAnnual; 
                hsForDisplayFreq = healthSurchargeAnnual; 
            }
            incomeTaxForFrequency = incomeTaxAnnual / frequencyDivisor;
            takeHomeForFrequency = annualTakeHomePay / frequencyDivisor;


            document.getElementById('resTotalNISSelectedFreq').textContent = formatCurrency(nisForDisplayFreq);
            document.getElementById('resHealthSurchargeSelectedFreq').textContent = formatCurrency(hsForDisplayFreq);
            document.getElementById('resDeductibleNISSelectedFreq').textContent = formatCurrency(actualDeductibleNIS / frequencyDivisor);
            document.getElementById('resDeductibleRegAnnuitySelectedFreq').textContent = formatCurrency(actualDeductibleRegisteredAnnuityInput / frequencyDivisor);
            document.getElementById('resTotalDeductionsSelectedFreq').textContent = formatCurrency(totalAllowableDeductionsAnnual / frequencyDivisor);
            document.getElementById('resTaxableIncomeSelectedFreq').textContent = formatCurrency(taxableIncomeAnnual / frequencyDivisor); 
            document.getElementById('resIncomeTaxSelectedFreq').textContent = formatCurrency(incomeTaxForFrequency);
            document.getElementById('resTotalPAYESelectedFreq').textContent = formatCurrency(totalPAYEAnnual / frequencyDivisor);
            document.getElementById('resAnnualTakeHomePay').textContent = formatCurrency(annualTakeHomePay); 
            document.getElementById('resTakeHomePaySelectedFreq').textContent = formatCurrency(takeHomeForFrequency); 
            
            resultsSection.classList.remove('hidden');
            payAllocationChartSection.classList.remove('hidden'); 
            annuityInsightsSection.classList.remove('hidden');
            adjustBentoLayout(); 

            renderPieChart('payAllocationPieChart', `Your ${frequencyString} Pay Allocation`,
                ['Health Surcharge', 'NIS', 'Income Tax', 'Take-home Pay'],
                [hsForDisplayFreq, nisForDisplayFreq, incomeTaxForFrequency, takeHomeForFrequency],
                true 
            );
            
            if (resultsSection && !resultsSection.classList.contains('hidden')) { 
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }


            const existingAnnuityInsightEl = document.getElementById('existingAnnuityInsight');
            if (totalAnnualRegisteredContrib > 0) { 
                 let currentTaxableIncomeForInsight = grossAnnualIncome - (totalAllowableDeductionsAnnual - actualDeductibleRegisteredAnnuityInput);
                 let taxWithoutCurrentAnnuity = calculateIncomeTax(currentTaxableIncomeForInsight);
                 const taxSavingFromCurrentAnnuity = taxWithoutCurrentAnnuity - incomeTaxAnnual;
                existingAnnuityInsightEl.innerHTML = `<h3 class="bento-section-title text-lg text-[var(--success-color)] mb-2">How Your Current Savings Help:</h3> <p class="text-[var(--text-secondary)] text-sm">Your total yearly savings of ${formatCurrency(totalAnnualRegisteredContrib, 0)} help lower your tax by <strong class="text-[var(--success-color)] font-semibold">${formatCurrency(actualDeductibleRegisteredAnnuityInput, 0)}</strong>.</p> ${actualDeductibleRegisteredAnnuityInput > 0 && taxSavingFromCurrentAnnuity > 0.01 ? `<p class="text-[var(--text-secondary)] text-sm mt-1">Great! That's about <strong class="text-[var(--secondary-accent)] font-semibold">${formatCurrency(taxSavingFromCurrentAnnuity, 0)}</strong> saved in taxes this year!</p>` : ''}`;
            } else {
                existingAnnuityInsightEl.innerHTML = `
                    <h3 class="bento-section-title text-lg text-[var(--success-color)] mb-2">Boost Your Savings & Lower Taxes!</h3>
                    <p class="text-[var(--text-secondary)] text-sm">Thinking of saving more? A registered annuity or company pension can help lower your taxes and grow your retirement fund!</p>
                `;
            }
            
            const recommendationsContainer = document.getElementById('annuityRecommendationsContainer');
            recommendationsContainer.innerHTML = ''; 
            const exploreFurtherHeadingEl = document.getElementById('exploreFurtherHeading');
            const exploreFurtherIntroEl = document.getElementById('exploreFurtherIntro');

            if (incomeTaxAnnual <= 0.01) { 
                exploreFurtherHeadingEl.textContent = 'Grow Your Money (Even Without Tax Breaks Now):';
                exploreFurtherIntroEl.textContent = 'No income tax right now? Smart! Unregistered annuities are still a great way to grow your money for the future. Take a look:';
            } else { 
                exploreFurtherHeadingEl.textContent = 'Save More & Pay Less Tax (with Registered Plans!):';
                exploreFurtherIntroEl.textContent = 'See how a registered plan can grow your retirement money AND cut your taxes. Choose a plan below:';
            }

            const percentages = [0.10, 0.15, 0.20]; 
            const yearsToRetirement = Math.max(0, RETIREMENT_AGE - age);

            percentages.forEach((percent, index) => {
                const recommendedAnnualContrib = grossAnnualIncome * percent;
                const cardSpecificIds = { 
                    pieCurrent: `currentPayePieChart${index}`, piePotential: `potentialPayePieChart${index}`, 
                    growth: `growthChart${index}`, visualizeBtn: `visualizeBtn${index}`, 
                    chartsWrapper: `chartsWrapper${index}`, taxView: `taxSavingsView${index}`, 
                    growthView: `growthChartView${index}`, summary: `payeSavingsSummary${index}`, 
                    toggleBtn: `toggleChartViewBtn${index}`
                };

                let cardHTML = `<div class="recommendation-card"> <h4 class="bento-section-title text-md text-[var(--success-color)] mb-2">Saving ${Math.round(percent*100)}% of Your Pay:</h4> <p class="text-sm text-[var(--text-secondary)]">If You Save This Yearly: <strong class="text-[var(--success-color)] font-semibold">${formatCurrency(recommendedAnnualContrib, 0)}</strong></p> <p class="text-sm text-[var(--text-secondary)]">That's about ${formatCurrency(recommendedAnnualContrib / frequencyDivisor, 0)} per ${frequencyString}!</p>`;
                let futureValue = yearsToRetirement > 0 ? calculateFutureValueAnnuity(recommendedAnnualContrib, ASSUMED_ANNUITY_INTEREST_RATE, yearsToRetirement) : 0;
                let taxSavingFromRecommendation = 0; 

                if (incomeTaxAnnual > 0.01) { 
                    const remainingCapRoom = Math.max(0, TAX_CONSTANTS.MAX_DEDUCTIBLE_NIS_ANNUITY_COMBINED - (actualDeductibleNIS + actualDeductibleRegisteredAnnuityInput));
                    const deductiblePortion = Math.min(recommendedAnnualContrib, remainingCapRoom); 
                    if (deductiblePortion > 0) {
                        taxSavingFromRecommendation = incomeTaxAnnual - calculateIncomeTax(Math.max(0, taxableIncomeAnnual - deductiblePortion)); 
                        cardHTML += `<p class="mt-2 text-sm font-medium text-[var(--text-secondary)]">Yearly Tax Saving Bonus: <strong class="text-[var(--secondary-accent)]">${formatCurrency(taxSavingFromRecommendation, 0)}</strong></p><p class="text-sm text-[var(--text-muted)]">(Based on ${formatCurrency(deductiblePortion, 0)} being tax-deductible)</p>`;
                        if (yearsToRetirement > 0) cardHTML += `<p class="mt-1 text-sm font-medium text-[var(--text-secondary)]">Total Tax Saved by Age ${RETIREMENT_AGE} (est.): <strong class="text-[var(--secondary-accent)] font-semibold">${formatCurrency(taxSavingFromRecommendation * yearsToRetirement, 0)}</strong></p>`;
                    } else cardHTML += `<p class="mt-2 text-sm text-[var(--text-secondary)]">Your tax deduction limit is likely maxed out. This plan focuses on pure growth!</p>`;
                }
                if (yearsToRetirement > 0) cardHTML += `<p class="mt-1 text-sm font-medium text-[var(--text-secondary)]">Your Nest Egg at Age ${RETIREMENT_AGE} (est. ${ASSUMED_ANNUITY_INTEREST_RATE*100}% yearly growth): <strong class="text-[var(--success-color)] text-md">${formatCurrency(futureValue, 0)}</strong></p>`;
                else if (age < RETIREMENT_AGE) cardHTML += `<p class="mt-1 text-sm font-medium text-[var(--text-secondary)]">Future Stash (1 yr): <strong class="text-[var(--success-color)] text-md">${formatCurrency(recommendedAnnualContrib * (1 + ASSUMED_ANNUITY_INTEREST_RATE), 0)}</strong></p>`;
                else cardHTML += `<p class="mt-1 text-sm text-[var(--text-secondary)]">Future projection not applicable.</p>`;
                
                cardHTML += `<div class="mt-4"><button id="${cardSpecificIds.visualizeBtn}" class="text-xs secondary-action-button button-base py-1.5 px-4">Explore Plan</button></div> <div id="${cardSpecificIds.chartsWrapper}" class="charts-view-wrapper" style="display:none;">`;
                if (incomeTaxAnnual <= 0.01) { 
                     if (yearsToRetirement > 0) cardHTML += `<div id="${cardSpecificIds.growthView}" class="chart-container"><canvas id="${cardSpecificIds.growth}"></canvas></div>`;
                     else cardHTML += `<p class="mt-2 text-sm text-[var(--text-secondary)] text-center">Future projection not applicable.</p>`;
                } else { 
                    cardHTML += `<div class="mt-3 mb-2 text-center"><button id="${cardSpecificIds.toggleBtn}" class="text-xs tertiary-action-button button-base py-1.5 px-4">See Growth Chart</button></div> 
                                 <div id="${cardSpecificIds.taxView}">
                                     <div class="grid md:grid-cols-2 gap-3">
                                         <div class="chart-container pie-chart-container"><canvas id="${cardSpecificIds.pieCurrent}"></canvas></div>
                                         <div class="chart-container pie-chart-container"><canvas id="${cardSpecificIds.piePotential}"></canvas></div>
                                     </div>
                                     <p id="${cardSpecificIds.summary}" class="text-center text-base font-semibold text-[var(--secondary-accent)] mt-4"></p>
                                 </div>`; 
                    if (yearsToRetirement > 0) cardHTML += `<div id="${cardSpecificIds.growthView}" class="chart-container" style="display:none;"><canvas id="${cardSpecificIds.growth}"></canvas></div>`;
                    else cardHTML += `<div id="${cardSpecificIds.growthView}" style="display:none;"><p class="mt-2 text-sm text-[var(--text-secondary)] text-center">Future projection not applicable.</p></div>`;
                }
                cardHTML += `</div></div>`; 
                recommendationsContainer.innerHTML += cardHTML;

                setTimeout(() => {
                    attachCardEventListeners(
                        index, cardSpecificIds, percent, recommendedAnnualContrib, 
                        incomeTaxAnnual, yearsToRetirement, 
                        actualDeductibleNIS, actualDeductibleRegisteredAnnuityInput, 
                        taxableIncomeAnnual, healthSurchargeAnnual, totalEmployeeNISAnnual, 
                        annualTakeHomePay, grossAnnualIncome,
                        totalPAYEAnnual 
                    );
                }, 50); 
            });

            const generalPromptContentEl = document.getElementById('generalAnnuityPromptContent');
            if (quoteIntervalId) {
                clearInterval(quoteIntervalId);
            }
            displayRandomQuote(); 
            quoteIntervalId = setInterval(displayRandomQuote, QUOTE_INTERVAL_MS); 

            if (incomeTaxAnnual <= 0.01) { 
                generalPromptContentEl.innerHTML = `
                    <h3 class="bento-section-title text-lg text-[var(--success-color)] mt-3 mb-2">Why Other Annuities Are Still Great (Even Without Upfront Tax Cuts!):</h3>
                    <p class="text-[var(--text-secondary)] text-sm">These annuities are still your friends for building future money:</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1 text-sm text-[var(--text-secondary)]">
                        <li><strong>Savings on Autopilot:</strong> Makes saving for your future easy peasy.</li>
                        <li><strong>Growth Potential:</strong> Your money can still grow over time, often tax-deferred (pay tax on growth later).</li>
                        <li><strong>Chill Retirement Income:</strong> Helps ensure you have cash flow when you're ready to relax.</li>
                        <li><strong>Compound Magic:</strong> Start early, even small bits, and watch it grow like a boss!</li>
                    </ul>
                    <p class="mt-3 text-[var(--text-secondary)] text-sm font-semibold">Chat with an advisor to see how this fits your big financial picture!</p>
                `;
            } else { 
                 generalPromptContentEl.innerHTML = `
                    <h3 class="bento-section-title text-lg text-[var(--success-color)] mt-3 mb-2">Registered Plans: Save on Taxes & Grow Your Future!</h3>
                    <p class="text-[var(--text-secondary)] text-sm">Paying taxes? Registered plans are a win-win: save for retirement AND lower your taxes today!</p>
                    <ul class="list-disc list-inside ml-4 mt-2 space-y-1 text-sm text-[var(--text-secondary)]">
                        <li><strong>Tax Slash, Right Now:</strong> Contributions are tax-deductible (up to limits), meaning less tax today!</li>
                        <li><strong>Tax-Free Growth Zone:</strong> Your investment grows without tax eating into it until retirement.</li>
                        <li><strong>Retirement Payday, Guaranteed:</strong> Get a steady income when you kick back and relax.</li>
                        <li><strong>Bonus Cash (Tax-Free!):</strong> Often, you can take out a chunk (like 25%) tax-free at retirement.</li>
                    </ul>
                    <p class="mt-3 text-[var(--text-secondary)] text-sm font-semibold">Let's optimize your annuity strategy. Talk to a pro!</p>
                `;
            }

            const unregAnnuityInsightEl = document.getElementById('unregisteredAnnuityInsight');
            if (unregAnnuityInsightEl) {
                unregAnnuityInsightEl.innerHTML = ''; 
                unregAnnuityInsightEl.style.display = 'none'; 
            }
        }
        
        // --- THEME TOGGLE FUNCTIONALITY ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const root = document.documentElement; 

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                root.classList.add('dark-mode');
                if (themeToggle) themeToggle.checked = true;
                if (themeToggleLabel) themeToggleLabel.textContent = 'DARK';
            } else {
                root.classList.remove('dark-mode');
                if (themeToggle) themeToggle.checked = false;
                if (themeToggleLabel) themeToggleLabel.textContent = 'LIGHT';
            }
            updateExistingCharts(); 
        }

        function toggleTheme() {
            const root = document.documentElement;
            const isDarkMode = root.classList.contains('dark-mode');
            
            if (isDarkMode) {
                root.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                if (themeToggleLabel) themeToggleLabel.textContent = 'LIGHT';
            } else {
                root.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                if (themeToggleLabel) themeToggleLabel.textContent = 'DARK';
            }
            updateExistingCharts();
        }

        function updateExistingCharts() {
            Object.keys(chartInstances).forEach(chartId => {
                if (chartInstances[chartId]?.update) {
                    const chart = chartInstances[chartId];
                    const colors = getChartColors(); 
                    
                    if (chart.config.type === 'pie') {
                        let currentLabels = chart.data.labels;
                        if(currentLabels.length === 2 && currentLabels[0] === 'Total PAYE'){ 
                             chart.data.datasets[0].backgroundColor = [colors.pie.payeEmphasis, colors.pie.takeHome];
                             chart.data.datasets[0].borderColor = Array(2).fill(colors.pie.borderColor);
                        } else { 
                             chart.data.datasets[0].backgroundColor = [colors.pie.healthSurcharge, colors.pie.nis, colors.pie.incomeTax, colors.pie.takeHome];
                             chart.data.datasets[0].borderColor = Array(4).fill(colors.pie.borderColor);
                        }
                        if(chart.options.plugins.title) chart.options.plugins.title.color = colors.textPrimaryColor;
                        if(chart.options.plugins.legend.labels) chart.options.plugins.legend.labels.color = colors.textSecondaryColor;
                        if(chart.options.plugins.datalabels) chart.options.plugins.datalabels.color = '#fff'; 

                    } else if (chart.config.type === 'line') {
                        chart.data.datasets.forEach((dataset, i) => {
                            if (i === 0) { 
                                dataset.borderColor = colors.line.borderColor;
                                dataset.backgroundColor = colors.line.backgroundColor;
                                dataset.pointBackgroundColor = colors.line.pointBackgroundColor;
                                dataset.pointBorderColor = colors.line.pointBorderColor;
                            } else { 
                                dataset.borderColor = colors.line.borderColorAlt;
                                dataset.backgroundColor = colors.line.backgroundColorAlt;
                                dataset.pointBackgroundColor = colors.line.borderColorAlt; 
                                dataset.pointBorderColor = colors.line.pointBorderColor;
                            }
                        });
                        if(chart.options.plugins.title) chart.options.plugins.title.color = colors.textPrimaryColor;
                        if(chart.options.plugins.legend.labels) chart.options.plugins.legend.labels.color = colors.textSecondaryColor;
                        if(chart.options.scales.y.ticks) chart.options.scales.y.ticks.color = colors.line.ticksColor;
                        if(chart.options.scales.x.ticks) chart.options.scales.x.ticks.color = colors.line.ticksColor;
                        if(chart.options.scales.y.grid) chart.options.scales.y.grid.color = colors.line.gridColor;
                    }
                    chart.update('none'); 
                }
            });
        }

        if (themeToggle) {
            themeToggle.addEventListener('change', toggleTheme);
        }
        
        // --- EVENT LISTENERS FOR INPUTS & BUTTONS ---
        const calculateButtonEl = document.getElementById('calculateButton');
        if (calculateButtonEl) {
            calculateButtonEl.addEventListener('click', () => {
                performFullCalculation(); 
                if (!window.initialCalculationPerformed && !resultsSection.classList.contains('hidden') && parseFloat(grossIncomeInput.value) > 0) { 
                    window.initialCalculationPerformed = true;
                    // Button text is set inside performFullCalculation
                }
                 // Auto-scroll to results on all devices after successful calculation
                if (resultsSection && !resultsSection.classList.contains('hidden') && parseFloat(grossIncomeInput.value) > 0) {
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }
        
        const financialInputsForButtonUpdate = [
            ageInput, incomeFrequencySelect, grossIncomeInput, hasAnnuityProductSelect, 
            companyPensionInput, companyPensionPercentageInput, personalAnnuityInput
        ];

        financialInputsForButtonUpdate.forEach(input => {
            if(input) {
                const eventType = input.tagName.toLowerCase() === 'select' ? 'change' : 'input';
                input.addEventListener(eventType, () => {
                    if (window.initialCalculationPerformed && calculateButton) {
                        calculateButton.textContent = "UPDATE MY PLAN";
                    }
                });
            }
        });
        
        if (hasAnnuityProductSelect) {
            hasAnnuityProductSelect.addEventListener('change', function() {
                const hasAnnuity = this.value === 'yes';
                companyPensionContainer.style.display = hasAnnuity ? 'block' : 'none';
                personalAnnuityContainer.style.display = hasAnnuity ? 'block' : 'none';
                
                if (!hasAnnuity) {
                    if(companyPensionInput) companyPensionInput.value = '';
                    if(companyPensionPercentageInput) companyPensionPercentageInput.value = '';
                    if(personalAnnuityInput) personalAnnuityInput.value = '';
                    if (companyPensionInputTypeRadios && companyPensionInputTypeRadios[0]) {
                        companyPensionInputTypeRadios[0].checked = true;
                        companyPensionAmountContainer.style.display = 'block';
                        companyPensionPercentageContainer.style.display = 'none';
                    }
                }
            });
        }
        
        if(companyPensionInputTypeRadios) {
            companyPensionInputTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'amount') {
                        companyPensionAmountContainer.style.display = 'block';
                        companyPensionPercentageContainer.style.display = 'none';
                        if(companyPensionPercentageInput) companyPensionPercentageInput.value = ''; 
                    } else if (this.value === 'percentage') {
                        companyPensionAmountContainer.style.display = 'none';
                        companyPensionPercentageContainer.style.display = 'block';
                        if(companyPensionInput) companyPensionInput.value = ''; 
                    }
                });
            });
        }

        if (incomeFrequencySelect) {
            incomeFrequencySelect.addEventListener('change', function() {
                updateFrequencySpecificText(capitalizeFirstLetter(this.value));
            });
        }
        
        if (getCustomQuoteBtn) { 
            getCustomQuoteBtn.addEventListener('click', function() {
                const amount = parseFloat(customAnnuityAmountInput.value);
                const frequency = customAnnuityFrequencySelect.value;
                
                customQuoteStatusMessageEl.textContent = ''; 
                customQuoteStatusMessageEl.classList.remove('text-[var(--paye-emphasis-color)]', 'text-[var(--success-color)]'); 

                if (isNaN(amount) || amount <= 0) {
                    customQuoteStatusMessageEl.textContent = 'Oops! Please enter a contribution amount greater than zero.';
                    customQuoteStatusMessageEl.classList.add('text-[var(--paye-emphasis-color)]'); 
                    customAnnuityAmountInput.focus(); 
                    return;
                }
                
                const whatsappMessage = `I would like a quote on an annuity with ${formatCurrency(amount,0)} ${capitalizeFirstLetter(frequency)} contributions please.`;
                const whatsappUrl = `https://wa.me/18683278273?text=${encodeURIComponent(whatsappMessage)}`;
                
                window.open(whatsappUrl, '_blank');

                customQuoteStatusMessageEl.textContent = `Opening WhatsApp to request your quote...`;
                customQuoteStatusMessageEl.classList.add('text-[var(--success-color)]'); 
                customQuoteStatusMessageEl.classList.remove('text-[var(--paye-emphasis-color)]');
            });
        }

        if (closeCustomQuoteModalBtn) { 
            closeCustomQuoteModalBtn.addEventListener('click', function() {
                closeModal('customQuoteModal');
            });
        }
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        function resetMobileZoom() {
            if (window.innerWidth < 768) {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                if (viewportMeta) {
                    viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0'; 
                    setTimeout(() => {
                        viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'; 
                    }, 300); 
                }
            }
        }

        // --- Back to Top and Mobile Scroll Hide/Show ---
        let mobileScrollTimeout;
        const allMobileFloatingButtons = document.querySelectorAll('.mobile-floating-button'); 

        function handleScrollEffects() {
            const isMobile = window.innerWidth < 768;
            let showBTT = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 200);

            if (backToTopButton) {
                if (showBTT) {
                    backToTopButton.classList.remove('opacity-0', 'invisible', 'hidden-by-scroll'); 
                    backToTopButton.classList.add('opacity-100', 'visible');
                } else {
                    backToTopButton.classList.remove('opacity-100', 'visible');
                    backToTopButton.classList.add('opacity-0', 'invisible');
                    if (isMobile) backToTopButton.classList.add('hidden-by-scroll');
                }
            }

            if (isMobile) {
                allMobileFloatingButtons.forEach(btn => {
                    if (btn.id === 'backToTopButton') { 
                        if (showBTT) btn.classList.add('hidden-by-scroll'); 
                    }
                });
                
                clearTimeout(mobileScrollTimeout);
                mobileScrollTimeout = setTimeout(function() {
                    allMobileFloatingButtons.forEach(btn => {
                         if (btn.id === 'backToTopButton') {
                           if (showBTT) btn.classList.remove('hidden-by-scroll');
                           else { 
                               btn.classList.remove('visible', 'opacity-100');
                               btn.classList.add('opacity-0', 'invisible', 'hidden-by-scroll');
                           }
                        }
                    });
                }, 250);
            } else { 
                 allMobileFloatingButtons.forEach(btn => {
                     btn.classList.remove('hidden-by-scroll');
                 });
            }
        }


        if (backToTopButton) {
            backToTopButton.addEventListener('click', () => {
                 if(financialDetailsBox) {
                     financialDetailsBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                 }
            });
        }

        // Initial setup calls on page load
        window.addEventListener('load', () => {
            adjustBentoLayout();
            updateFrequencySpecificText(capitalizeFirstLetter(incomeFrequencySelect.value)); 
            initializeTheme(); 
            handleScrollEffects(); 
            window.addEventListener('scroll', handleScrollEffects); 
        }); 
        window.addEventListener('resize', () => {
            adjustBentoLayout();
            updateFrequencySpecificText(capitalizeFirstLetter(incomeFrequencySelect.value)); 
            updateExistingCharts(); 
            handleScrollEffects(); 
        }); 
    </script>
</body>
</html>
